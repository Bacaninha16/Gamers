<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>Atmosfera Musical Pro</title>

<style>
:root {
  --accent: hsl(200, 90%, 60%);
  --bg: #050505;
}

html, body {
  margin: 0;
  width: 100%;
  height: 100%;
  background: var(--bg);
  color: white;
  font-family: 'Segoe UI', Roboto, sans-serif;
  overflow: hidden;
}

canvas { display: block; }

/* UI */
#ui {
  position: fixed;
  left: 50%;
  bottom: calc(env(safe-area-inset-bottom, 0px) + 10px);
  transform: translateX(-50%);
  width: 100%;
  max-width: 720px;
  padding: 12px;
  box-sizing: border-box;
  z-index: 10;
  pointer-events: none;
}

#info {
  font-size: 0.75rem;
  letter-spacing: 3px;
  text-transform: uppercase;
  text-align: center;
  opacity: 0.6;
  margin-bottom: 10px;
}

.controls-row {
  pointer-events: auto;
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  justify-content: center;
  align-items: center;
  background: rgba(255,255,255,0.05);
  padding: 12px;
  border-radius: 22px;
  backdrop-filter: blur(16px);
  border: 1px solid rgba(255,255,255,0.1);
}

button, input[type="file"]::file-selector-button {
  background: rgba(255,255,255,0.08);
  border: 1px solid rgba(255,255,255,0.15);
  color: white;
  padding: 10px 16px;
  border-radius: 40px;
  cursor: pointer;
  font-weight: 600;
}

button:hover {
  background: var(--accent);
  box-shadow: 0 0 12px var(--accent);
}

audio {
  width: 100%;
  max-width: 260px;
  height: 34px;
}

/* Pain√©is */
#panel, #settings {
  position: fixed;
  top: 0;
  width: 280px;
  height: 100%;
  background: rgba(5,5,5,0.92);
  backdrop-filter: blur(30px);
  padding: 30px 20px;
  transition: 0.45s cubic-bezier(0.19,1,0.22,1);
  z-index: 100;
}

#panel { right: -320px; border-left: 1px solid rgba(255,255,255,0.1); }
#settings { left: -320px; border-right: 1px solid rgba(255,255,255,0.1); }

#panel.open { right: 0; }
#settings.open { left: 0; }

.palette {
  display: grid;
  grid-template-columns: repeat(3,1fr);
  gap: 15px;
  margin-top: 30px;
}

.color-dot {
  aspect-ratio: 1;
  border-radius: 50%;
  cursor: pointer;
  transition: .3s;
}

.color-dot:hover {
  transform: scale(1.2);
  border: 2px solid white;
}

.setting { margin-bottom: 30px; }
.value { opacity: .7; font-size: .85rem; }

/* Mobile */
@media (max-width:600px){
  audio { max-width: 100%; }
}
</style>
</head>

<body>

<canvas id="canvas"></canvas>

<div id="settings">
  <button onclick="toggleSettings()" style="width:100%">VOLTAR</button>

  <div class="setting">
    <h3>Sensibilidade</h3>
    <input type="range" min="0.5" max="3" step="0.1" id="sensitivity">
    <span class="value" id="sensValue"></span>
  </div>

  <div class="setting">
    <h3>Bolinhas</h3>
    <input type="range" min="0" max="300" step="10" id="particleCount">
    <span class="value" id="particleValue"></span>
  </div>

  <div class="setting" id="beatSetting" style="display:none">
    <label>
      <input type="checkbox" id="beatToggle">
      Trocar cor na batida
    </label>
  </div>
</div>

<div id="panel">
  <button onclick="togglePanel()" style="width:100%">VOLTAR</button>
  <h3 style="margin-top:30px;font-weight:300;">Ambiente</h3>
  <div class="palette" id="palette"></div>
</div>

<div id="ui">
  <div id="info">Pronto para come√ßar</div>
  <div class="controls-row">
    <input type="file" id="file" accept="audio/*">
    <audio id="audio" controls></audio>
    <button id="toggleMic">üé§</button>
    <button onclick="toggleSettings()">‚öôÔ∏è</button>
    <button onclick="togglePanel()">üé®</button>
  </div>
</div>

<script>
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
const audio = document.getElementById("audio");
const fileInput = document.getElementById("file");
const info = document.getElementById("info");
const toggleMicBtn = document.getElementById("toggleMic");
const palette = document.getElementById("palette");

let w, h, audioCtx, analyser, dataArray, source;
let particles = [], explosionParticles = [], stream = null, isMic = false;

let baseHue = +localStorage.getItem("baseHue") || 200;
let sensitivity = +localStorage.getItem("sensitivity") || 1;
let particleTarget = +localStorage.getItem("particles") || 80;

let rainbow = false;
let beatMode = false;
let lastEnergy = 0;

const beatToggle = document.getElementById("beatToggle");
const beatSetting = document.getElementById("beatSetting");

document.documentElement.style.setProperty("--accent", `hsl(${baseHue},90%,60%)`);

function resize() {
  w = canvas.width = innerWidth;
  h = canvas.height = innerHeight;
}
addEventListener("resize", resize);
resize();

/* Sliders */
const sensSlider = document.getElementById("sensitivity");
const sensValue = document.getElementById("sensValue");
const particleSlider = document.getElementById("particleCount");
const particleValue = document.getElementById("particleValue");

sensSlider.value = sensitivity;
particleSlider.value = particleTarget;
sensValue.textContent = sensitivity + "x";
particleValue.textContent = particleTarget + " bolinhas";

sensSlider.oninput = () => {
  sensitivity = +sensSlider.value;
  sensValue.textContent = sensitivity + "x";
  localStorage.setItem("sensitivity", sensitivity);
};

particleSlider.oninput = () => {
  particleTarget = +particleSlider.value;
  particleValue.textContent = particleTarget + " bolinhas";
  localStorage.setItem("particles", particleTarget);
  adjustParticles();
};

beatToggle.onchange = () => beatMode = beatToggle.checked;

/* Paleta */
[0, 30, 150, 200, 270, 320, "rainbow"].forEach(h => {
  const d = document.createElement("div");
  d.className = "color-dot";
  d.style.background = h === "rainbow"
    ? "linear-gradient(135deg,red,orange,yellow,green,cyan,blue,violet)"
    : `hsl(${h},80%,50%)`;
  d.onclick = () => {
    if (h === "rainbow") {
      rainbow = true;
      beatSetting.style.display = "block";
    } else {
      rainbow = false;
      beatMode = false;
      beatToggle.checked = false;
      beatSetting.style.display = "none";
      baseHue = h;
      document.documentElement.style.setProperty("--accent", `hsl(${baseHue},90%,60%)`);
      localStorage.setItem("baseHue", baseHue);
    }
  };
  palette.appendChild(d);
});

/* √Åudio */
async function initAudio() {
  if (!audioCtx) {
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    analyser = audioCtx.createAnalyser();
    analyser.fftSize = 256;
    dataArray = new Uint8Array(analyser.frequencyBinCount);
  }
  if (audioCtx.state === "suspended") await audioCtx.resume();
}

toggleMicBtn.onclick = async () => {
  await initAudio();
  if (!isMic) {
    audio.pause();
    stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    if (source) source.disconnect();
    source = audioCtx.createMediaStreamSource(stream);
    source.connect(analyser);
    isMic = true;
    info.textContent = "Microfone ativo";
  } else {
    stream?.getTracks().forEach(t => t.stop());
    isMic = false;
    info.textContent = "Pronto para come√ßar";
  }
};

fileInput.onchange = e => {
  const file = e.target.files[0];
  if (file) {
    audio.src = URL.createObjectURL(file);
    info.textContent = `Carregando: ${file.name}`;
  }
};

audio.onplay = async () => {
  await initAudio();
  if (source) source.disconnect();
  source = audioCtx.createMediaElementSource(audio);
  source.connect(analyser);
  analyser.connect(audioCtx.destination);
  info.textContent = "Tocando arquivo";
};

/* Part√≠culas normais */
class Particle {
  constructor() { this.reset(); }
  reset() {
    this.x = Math.random() * w;
    this.y = Math.random() * h;
    this.s = Math.random() * 2 + 0.5;
    this.v = Math.random() * 1 + 0.2;
  }
  update(f) {
    this.y -= this.v + f * 8;
    if (this.y < -10) this.reset();
  }
  draw() {
    ctx.fillStyle = `hsla(${baseHue},80%,70%,0.7)`;
    ctx.beginPath();
    ctx.arc(this.x, this.y, this.s, 0, Math.PI * 2);
    ctx.fill();
  }
}

/* Part√≠culas de explos√£o (nova) */
class ExplosionParticle {
  constructor(x, y, hue) {
    this.x = x;
    this.y = y;
    this.hue = hue;
    this.size = Math.random() * 3 + 2;
    this.speed = Math.random() * 6 + 3;
    this.angle = Math.random() * Math.PI * 2;
    this.vx = Math.cos(this.angle) * this.speed;
    this.vy = Math.sin(this.angle) * this.speed;
    this.life = 1;
    this.decay = 0.015 + Math.random() * 0.015;
  }
  update() {
    this.x += this.vx;
    this.y += this.vy;
    this.vy += 0.15; // gravidade leve
    this.life -= this.decay;
    this.size *= 0.98;
  }
  draw() {
    if (this.life <= 0) return;
    ctx.globalAlpha = this.life * 0.9;
    ctx.fillStyle = `hsla(${this.hue}, 90%, 65%, ${this.life})`;
    ctx.beginPath();
    ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
    ctx.fill();
    ctx.globalAlpha = 1;
  }
}

function adjustParticles() {
  while (particles.length < particleTarget) particles.push(new Particle());
  while (particles.length > particleTarget) particles.pop();
}
adjustParticles();

function createExplosion(x, y, count = 30) {
  for (let i = 0; i < count; i++) {
    explosionParticles.push(new ExplosionParticle(x, y, baseHue));
  }
}

/* Render */
function draw() {
  requestAnimationFrame(draw);

  ctx.fillStyle = "rgba(5,5,5,0.15)";
  ctx.fillRect(0, 0, w, h);

  let energy = 0;
  if (analyser) {
    analyser.getByteFrequencyData(dataArray);
    energy = dataArray.reduce((a, b) => a + b, 0) / dataArray.length;
  }

  const delta = energy - lastEnergy;
  lastEnergy = energy;

  // Detec√ß√£o de batida + explos√£o
  const beatThreshold = 8 + sensitivity * 3;
  if (delta > beatThreshold && energy > 40) {
    if (rainbow && beatMode) {
      baseHue = Math.random() * 360;
      document.documentElement.style.setProperty("--accent", `hsl(${baseHue},90%,60%)`);
    }
    // Explos√£o no centro
    createExplosion(w / 2, h / 2, 25 + Math.floor(energy / 10));
  }

  // Desenha barras de frequ√™ncia
  const barW = (w / dataArray.length) * 2;
  let x = 0;
  for (let i = 0; i < dataArray.length / 2; i++) {
    const hBar = (dataArray[i] / 255) * (h / 2.5) * sensitivity;
    ctx.fillStyle = `hsla(${baseHue},80%,60%,0.8)`;
    ctx.fillRect(w / 2 + x, h / 2 - hBar / 2, barW - 2, hBar);
    ctx.fillRect(w / 2 - x, h / 2 - hBar / 2, barW - 2, hBar);
    x += barW;
  }

  // Atualiza e desenha part√≠culas normais
  particles.forEach(p => {
    p.update(energy / 255);
    p.draw();
  });

  // Atualiza e desenha explos√µes
  explosionParticles = explosionParticles.filter(p => p.life > 0);
  explosionParticles.forEach(p => {
    p.update();
    p.draw();
  });

  // Limite de seguran√ßa (performance)
  if (explosionParticles.length > 400) {
    explosionParticles = explosionParticles.slice(-300);
  }
}
draw();

function toggleSettings() { document.getElementById("settings").classList.toggle("open"); }
function togglePanel() { document.getElementById("panel").classList.toggle("open"); }
</script>
</body>
</html>